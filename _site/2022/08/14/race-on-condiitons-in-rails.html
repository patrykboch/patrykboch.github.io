<!DOCTYPE html><html lang="en" ><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"> <script async src="https://www.googletagmanager.com/gtag/js?id=G-Y7YWNPD60C"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-Y7YWNPD60C'); </script><meta name="generator" content="Jekyll v3.9.0" /><meta property="og:title" content="Race (on) condition(s) in Rails" /><meta name="author" content="Patryk" /><meta property="og:locale" content="en_US" /><meta name="description" content="How to solve race condition problems in rails" /><meta property="og:description" content="How to solve race condition problems in rails" /><link rel="canonical" href="http://localhost:4000/2022/08/14/race-on-condiitons-in-rails" /><meta property="og:url" content="http://localhost:4000/2022/08/14/race-on-condiitons-in-rails" /><meta property="og:site_name" content="boch.dev" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-08-14T00:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Race (on) condition(s) in Rails" /><meta name="twitter:site" content="@Boch_Patryk" /><meta name="twitter:creator" content="@patrykboch" /> <script type="application/ld+json"> {"description":"How to solve race condition problems in rails","headline":"Race (on) condition(s) in Rails","dateModified":"2022-08-14T00:00:00+02:00","datePublished":"2022-08-14T00:00:00+02:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2022/08/14/race-on-condiitons-in-rails"},"url":"http://localhost:4000/2022/08/14/race-on-condiitons-in-rails","author":{"@type":"Person","name":"Patryk"},"@context":"https://schema.org"}</script><title> Race (on) condition(s) in Rails - boch.dev</title><link rel="shortcut icon" href="/favicon.png"><link rel="alternate" type="application/atom+xml" title="boch.dev" href="/atom.xml"><link rel="alternate" type="application/json" title="boch.dev" href="http://localhost:4000/feed.json" /><link rel="sitemap" type="application/xml" title="sitemap" href="/sitemap.xml" /><style> @import url("https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600&display=swap");*,:after,:before{box-sizing:border-box;background-color:inherit;color:inherit;margin:0;padding:0}body{font-family:system-ui, sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;line-height:1.5;font-size:1rem;color:#16171a}nav ul{border-right:1px solid #edf2f7}a{color:#000;text-decoration-skip-ink:auto;text-decoration:underline}pre{margin:0.5rem 0;padding:0.5rem}.post{font-family:"Source Sans Pro",sans-serif}.post p{line-height:18pt;margin:0.5rem 0}.post h1,.post h2,.post h3,.post h4{margin:1rem 0}.post h2:first-child,.project h2:first-child,.photo h2:first-child{margin-top:0}.gist{margin-top:10px}.meta{margin:2rem 0}code,pre{-webkit-border-radius:5px;-moz-border-radius:5px;border-radius:5px}.logo{color:red}code{font-size:15px;padding:0.1rem}pre code{border:none}pre{padding:1rem;overflow-x:auto}img{max-width:100%}hr{background:#000;height:1px;border:0}header{flex-basis:10rem;flex-grow:1;position:relative}header a{text-decoration:none;font-family:"Source Sans Pro",sans-serif}header li{margin-bottom:0.2rem;text-align:right;margin-right:2rem}header a.active{font-family:"Source Sans Pro",sans-serif;font-weight:bold}header,section{padding:1rem}blockquote{border-left:5px solid #ececec;padding-left:1rem;margin:2% 0;font-size:17px}h1,h2,h3,h4,h5{line-height:1;margin:1rem 0;font-weight:600}section h1:first-child{margin-top:0}strong,b{font-weight:bold}.photos ul{list-style:none}.photos li{margin-bottom:1.5rem}.photo picture,.project picture{margin-bottom:0.5rem}.posts ul,header ul{list-style:none}.posts li{align-items:center;display:flex;justify-content:space-between;margin-bottom:0.5rem}.post li{list-style-type:circle;margin-bottom:20px}.posts li a,.posts li div,.projects li a{font-family:"Source Sans Pro",sans-serif;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-decoration:none}.posts li time,.projects li time{font-family:"Source Sans Pro",sans-serif;font-weight:400;font-size:13px;color:red;padding-left:1rem;white-space:nowrap;font-variant-numeric:tabular-nums}.post ul,.project ul,.post ol{margin:0 0 20px 20px}main{display:flex;flex-wrap:wrap;max-width:60rem;margin:2rem auto;padding:1rem}@media screen and (max-width: 45rem){header li{display:inline;margin-right:1rem}.logo{padding-bottom:1rem}header ul{border-bottom:1px solid #edf2f7;padding-bottom:2rem}nav ul{border-right:0px}.photos ul{margin-top:0.5rem}}section{flex-basis:0;flex-grow:999;min-width:70%;display:flex;flex-direction:column;text-align:justify}table{width:100%;border-collapse:collapse;text-align:left;overflow:hidden}table td,table th{border-top:1px solid #ecf0f1;padding:10px}table td{border-left:1px solid #ecf0f1;border-right:1px solid #ecf0f1}table th{background-color:#e9e8e8}figcaption{font-size:smaller}.highlight .c,.highlight .cm,.highlight .c1,.highlight .cs{color:#408080}.highlight .k,.highlight .kc,.highlight .kd,.highlight .kn,.highlight .kp,.highlight .kr,.highlight .sx,.highlight .bp,.highlight .nt,.highlight .nb{color:#008000}.highlight .o,.highlight .m,.highlight .mf,.highlight .mh,.highlight .mi,.highlight .mo,.highlight .il{color:#666666}.highlight .cp{color:#bc7a00}.highlight .gd{color:#a00000}.highlight .gr{color:#ff0000}.highlight .gh,.highlight .gp{color:#000080}.highlight .gi{color:#00a000}.highlight .go{color:#808080}.highlight .gu{color:#800080}.highlight .gt{color:#0040d0}.highlight .kt{color:#b00040}.highlight .na{color:#7d9029}.highlight .no{color:#880000}.highlight .nd,.highlight .ow{color:#aa22ff}.highlight .ni{color:#999999}.highlight .ne{color:#d2413a}.highlight .nc,.highlight .nf,.highlight .nn{color:#0000ff}.highlight .nl{color:#a0a000}.highlight .w{color:#bbbbbb}.highlight .s,.highlight .sb,.highlight .sc,.highlight .sd,.highlight .s2,.highlight .sh,.highlight .s1{color:#ba2121}.highlight .se{color:#bb6622}.highlight .si,.highlight .sr{color:#bb6688}.highlight .ss,.highlight .vs,.highlight .vg,.highlight .vi,.highlight .nv{color:#19177c}.highlight .c,.highlight .cm,.highlight .c1,.highlight .cs,.highlight .ge,.highlight .sd{font-style:italic}.highlight .k,.highlight .kc,.highlight .kd,.highlight .kn,.highlight .kr,.highlight .gh,.highlight .gp,.highlight .gs,.highlight .gu,.highlight .nc,.highlight .ni,.highlight .ne,.highlight .nn,.highlight .nt,.highlight .ow,.highlight .se,.highlight .si{font-weight:bold}</style></head><body><main role="main"><header role="banner"><nav role="navigation"><ul> <img src="https://avatars1.githubusercontent.com/u/42003319?s=460&u=22038b8d46cbc023fbde6b7fc730f6d2ce522826&v=4" style="border-radius: 50%!important;" width="90%"/><li><a href="/" class="logo">boch.dev</a></li><li><a href="/" >Dull posts</a></li><li><a href="/about" >About me</a></li><li><a href="/contact" >Contact info</a></li><li><a href="/atom.xml" >Rss</a></li></ul></nav></header><section class="post"> <span><time datetime="2022-08-14T00:00:00+02:00">August 14, 2022</time> &middot; <a href="/tag/ruby">ruby</a>, <a href="/tag/rails">rails</a>, <a href="/tag/race condition">race condition</a>, <a href="/tag/optimistic lock">optimistic lock</a>, <a href="/tag/pessimistic lock">pessimistic lock</a> </span><h2>Race (on) condition(s) in Rails</h2><p>Some argue that Ruby on Rails applications cannot scale. That is a common response given by candidates in job interviews when asked about the disadvantages of the framework. I don’t want to choose a side. I might respond, “it depends” - as always. Anyhow, if you want to prepare your app for receiving numerous requests at once, you need to consider the <em>race condition</em> issue which is liable to cause us troubles.</p><p>I don’t want to delve into the definition of “race condition” as I’m sure my readers understand what it is because it is fundamental to software engineering. I’d like to concentrate on ways to get rid of this. If you’re unfamiliar and you want to discover more about the term’s origins, go <a href="https://devopedia.org/race-condition-software">here</a>. Anyways, one line will adequately describe the problem.</p><blockquote><p>When your app allows multiple requests to interact with the same records, and one request overrides changes made by another without taking them into account.</p></blockquote><p>For instance, if a large number of requests modify the same record at the same time in multi-users scenario.</p><p>As my final point in this introduction, I want to emphasize that a database must ensure integrity of data, particularly when performing concurrent operations. Integrity introduces the ACID-compliant idea of “locking” into the picture. Because of this, both optimistic and pessimistic locking are considered as means of addressing race condition issues.</p><h2 id="optimistic-locking">Optimistic locking</h2><p>Optimistic locking is when the version attribute maintained in a database column is taken into account. It’s the implicit technique of dodging the issue IMO. If we intend to use it, the special <em>lock_version</em> column needs to be added and Active Record, which is Rails’ default component, takes care of minimizing data conflicts.</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">add_column</span> <span class="ss">:table_name</span><span class="p">,</span> <span class="ss">:lock_version</span><span class="p">,</span> <span class="ss">:integer</span>
</code></pre></div></div><p>Each time a record is updated, the <code class="language-plaintext highlighter-rouge">lock_version</code> entity is increased and the locking features make sure that records will only allow the last one stored to throw a <code class="language-plaintext highlighter-rouge">StaleObjectError</code> if there is a parallel update of any kind. Then, we can attempt updating the data again.</p><script src="https://gist.github.com/patrykboch/99296a4395b362ed3dbd279adedf02b1.js"></script><p>Rails are adaptable; if you want to use your own table with a name that differs from <em>lock_version</em> you can do so by specyfing in your model:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">self</span><span class="p">.</span><span class="nf">locking_column</span> <span class="o">=</span> <span class="ss">:custom_lock_version</span>
</code></pre></div></div><p>Why is this type of dealing with race condition regarded as optimistic? Because it is assumed that database conflicts occur less frequently. Optimistic locking performs by simply comparing the “version” column value. As a result, it does not represent a true database lock.</p><h2 id="pessimistic-locking">Pessimistic locking</h2><p>Pessimistic locking, on the other hand, is a technique that counts on more frequent database conflicts. Since it offers an exclusive lock on the record, it is regarded as more explicit. When a single request modifies a record, it locks it until a transaction is completed. For this purpose a built-in methods <code class="language-plaintext highlighter-rouge">with_lock</code> and <code class="language-plaintext highlighter-rouge">#lock!</code> are used. Both operate similarly to each other. The main difference is that the <code class="language-plaintext highlighter-rouge">#lock!</code> needs to be used within an Active Record’s transaction since it is unlocked again when the surrounding transaction is finished; sadly, using it outside the transaction block is ineffective. The <code class="language-plaintext highlighter-rouge">with_lock</code> method initiates a database transaction by itself. Anyways, all methods prevent others from reading or writing a record until the transaction is completed.</p><script src="https://gist.github.com/patrykboch/0ec6ae5943fc43331771a34ac1df9fe2.js"></script><p><a href="https://api.rubyonrails.org/classes/ActiveRecord/Locking/Pessimistic.html">See the <code class="language-plaintext highlighter-rouge">with_lock</code> API reference</a>.</p><h2 id="what-to-choose">What to choose?</h2><p>Both locking methods are regarded as useful; however, the cost of a transaction retry must be considered when selecting a suitable locking scheme. It is determined by app requirements and business logic. Let’s summarize these two approaches briefly. <br /> <br /></p><table><thead><tr><th>Optimistic locking</th><th>Pessimistic locking</th></tr></thead><tbody><tr><td>Locks a record once changes are comitted to db</td><td>Locks record once it is edited</td></tr><tr><td>Considers data conflicts less frequently</td><td>Considers data conflicts more frequently</td></tr><tr><td>Needs a version number stored in a db column for locking a record</td><td>Needs an invocation of <code class="language-plaintext highlighter-rouge">with_lock</code> or <code class="language-plaintext highlighter-rouge">#lock!</code> methods for locking a record</td></tr><tr><td>Allows a conflict to occur and may retry or throw an error</td><td>Blocks conflicts until a record is unlocked (a transaction is done)</td></tr><tr><td>Is used once a cost of retry is low</td><td>Is used once a cost of retry is high</td></tr></tbody></table><p><br /> Rather than locking a record for entire transactions by pessimistic way, I’d take the optimistic approach and that’s what I recommend. As alwyas, at the end, it depends on the use case that may force the pessimistic approach.</p><p>There are more methods besides optimism and pessimism to stay away from race conditions. Since more libraries need to be installed, let’s quickly go over the details of two additional, more particular approaches.</p><h2 id="what-else">What else?</h2><h3 id="advisory-locking">Advisory locking</h3><p>Another useful technique is the advisory locking. It doesn’t lock records but guarantees that no two processes operate another process at the same time (by adding mutexes). In order to do so you’d need to extend an app with <a href="https://github.com/ClosureTree/with_advisory_lock"><em>with_advisory_lock</em></a> gem. See official docs for details.</p><h3 id="background-processing-and-queues">Background processing and queues</h3><p>I’m sure that all readers know what background processing is as it’s fundamental. In ruby apps Sidekiq is used frequently to handle background jobs that may alter db records. An extension to Sidekiq - <a href="https://github.com/mhenrixon/sidekiq-unique-jobs">SidekiqUniqueJobs</a> adds extra constraints and prevents from race conditions there. The configuration is pretty straight forward since only an extra middleware must be configured. See official docs for details.</p><h2 id="summary">Summary</h2><p>It may be difficult to create consistent systems without problems with data integrity so knowing strategies that let us avoid race conditions are desirable. Of course, there are more locking strategies, but I’ve only shown those that I find most useful in my day-to-day work as a developer.</p></section></main></body></html>
